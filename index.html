<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Rotary Motion Sensor</title>
  <link rel="icon" href="data:,"> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #controls { margin-bottom: 20px; }
    button { margin-right: 10px; padding: 6px 12px; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ESP32 Rotary Motion Sensor</h2>

  <div id="controls">
    <button id="connectBtn">üîó Connect to ESP32 (Live Data)</button>
    <button id="startSimBtn" disabled>‚ñ∂ Start Simulation (Disabled)</button>
    <button id="stopSimBtn" disabled>‚èπ Stop Simulation (Disabled)</button>
    <p id="status">Status: Disconnected</p>
  </div>

  <canvas id="angleChart" width="800" height="400"></canvas>

  <script>
    const ctx = document.getElementById('angleChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Angle (degrees)',
          data: [],
          borderColor: 'blue',
          fill: false
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Time (s)' } },
          y: { title: { display: true, text: 'Angle (deg)' } }
        }
      }
    });

    let startTime = Date.now();

    // ble live data
    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        console.log("Requesting Bluetooth device...");
        document.getElementById('status').innerText = 'Status: Scanning...';
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
        });
        console.log("Device selected:", device.name, device.id);
        document.getElementById('status').innerText = 'Status: Device selected';

        device.addEventListener('gattserverdisconnected', () => {
          console.log("Device disconnected.");
          document.getElementById('status').innerText = 'Status: Disconnected';
          chart.data.labels = [];
          chart.data.datasets[0].data = [];
          chart.update();
        });

        console.log("Connecting to GATT server...");
        document.getElementById('status').innerText = 'Status: Connecting...';
        const server = await device.gatt.connect();

        console.log("Getting primary service...");
        document.getElementById('status').innerText = 'Status: Getting service...';
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');

        console.log("Getting characteristic...");
        document.getElementById('status').innerText = 'Status: Getting characteristic...';
        const characteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');

        console.log("Starting notifications...");
        document.getElementById('status').innerText = 'Status: Starting notifications...';
        await characteristic.startNotifications();

        characteristic.addEventListener('characteristicvaluechanged', (event) => {
          const value = new TextDecoder().decode(event.target.value);
          try {
            const obj = JSON.parse(value);
            const elapsed = (Date.now() - startTime) / 1000;
            chart.data.labels.push(elapsed.toFixed(2));
            chart.data.datasets[0].data.push(obj.angle);
            chart.update();
            console.log("Data:", obj);
            document.getElementById('status').innerText = 'Status: Connected - Receiving data';
          } catch (e) {
            console.warn("Invalid JSON from ESP32:", value);
          }
        });

        console.log("Connected and listening!");
        document.getElementById('status').innerText = 'Status: Connected';
      } catch (error) {
        console.error("Connection failed:", error);
        document.getElementById('status').innerText = `Status: Error - ${error}`;
      }
    });

    // simulation 
    let simInterval;
    function startSimulation() {
      let t = 0;
      simInterval = setInterval(() => {
        const simulatedAngle = 180 * Math.sin(t);
        const elapsed = (Date.now() - startTime) / 1000;
        chart.data.labels.push(elapsed.toFixed(2));
        chart.data.datasets[0].data.push(simulatedAngle);
        chart.update();
        t += 0.1;
      }, 100);
    }
    function stopSimulation() { clearInterval(simInterval); }

    document.getElementById('startSimBtn').addEventListener('click', startSimulation);
    document.getElementById('stopSimBtn').addEventListener('click', stopSimulation);
  </script>
</body>
</html>